---
title: 2023-12-02 如何从 RQrun 导出数据
tags: [run, tech]
key: 20231202_rqrun_export
---

这是一个很不常见的需求，恰好我就遇到了。在今天的[另一篇 blog]({% post_url 2023-12-02-小修又病了 %}) 里提到了，因为 Apple Watch 在我运动暂停时自动关机并且无法再开机，我只好用手机上的 RQrun app 记录了一小段跑步，我需要将它导出并上传到 Strava。

<!--more-->

搜索了一下，还好有人研究过这个问题并分享了[方法](https://www.bilibili.com/read/cv24873248/)。我运气不错，因为只搜索出这一个相关的页面，而且它的创建时间是今年 7 月 8 日，不到 5 个月前。毕竟 RQrun 是一个相对小众的软件，用的人应该不多，有我这样的需求还懂前端技术而且愿意动手解决的可想而知多么少。

作者在文章开头就提到

> 仅供个人研究，如果触犯RQrun公司的利益，私信我会删除。

所以为了自己留着备用，我把最关键的代码记录在这里，防止将来找不到了。方法如下：

在浏览器里打开需要导出的记录，打开开发人员工具（F12 或者 Ctrl-Shift-I），在控制台执行以下代码

```
$('<button type="submit" class="layui-btn layui-badge layui-bg-green" style="top:-5px;margin-left:10px" id="load_gpx"><i class="fas fa-save"></i> 导出GPX</button>').prependTo("#breadcrumb").bind('click',function(){$.ajax({url:"/Dc/Api",type:'get',dataType:'json',data:{_:'User/Record/get_record_info',record_id:RECORD_ID,coordinate_id:3,student_user_id:STUDENT_USER_ID,group_id:GROUP_ID},success:function(res){if(res.status===0){const data=res.data;const gpx='<?xml version="1.0" encoding="UTF-8"?><gpx creator="Garmin Connect" version="1.1" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/11.xsd" xmlns:ns3="http://www.garmin.com/xmlschemas/TrackPointExtension/v1" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ns2="http://www.garmin.com/xmlschemas/GpxExtensions/v3"><metadata><link href="connect.garmin.com"><text>Garmin Connect</text></link><time></time></metadata><trk><name>下午跑步</name><type>running</type><trkseg></trkseg></trk></gpx>';const parser=new DOMParser();const xmlDoc=parser.parseFromString(gpx,"text/xml");const trkseg=xmlDoc.getElementsByTagName("trkseg")[0];const name=xmlDoc.getElementsByTagName("name")[0];name.textContent='导出的数据';const stime=xmlDoc.getElementsByTagName("time")[0];stime.textContent=new Date(data['swim_length_sum']['start_time']*1000).toISOString();data.trkpt.forEach((point)=>{const trkpt=xmlDoc.createElement("trkpt");trkpt.setAttribute("lat",point.position_lat);trkpt.setAttribute("lon",point.position_long);const ele=xmlDoc.createElement("ele");ele.textContent=point.altitude;trkpt.appendChild(ele);const time=xmlDoc.createElement("time");time.textContent=new Date(point.timestamp*1000).toISOString();trkpt.appendChild(time);const extension=xmlDoc.createElement("extensions");const trackPointExtension=xmlDoc.createElement("ns3:TrackPointExtension");const hr=xmlDoc.createElement("ns3:hr");hr.textContent=point.heart_rate;trackPointExtension.appendChild(hr);const cad=xmlDoc.createElement("ns3:cad");cad.textContent=point.cadence;trackPointExtension.appendChild(cad);extension.appendChild(trackPointExtension);trkpt.appendChild(extension);trkseg.appendChild(trkpt)});const xmlString=new XMLSerializer().serializeToString(xmlDoc);const cleanedXmlString=xmlString.replace(/xmlns=""/g,"");const blob=new Blob([cleanedXmlString],{type:"application/gpx+xml"});const url=URL.createObjectURL(blob);const link=document.createElement("a");link.href=url;link.download="file.gpx";document.body.appendChild(link);link.click();URL.revokeObjectURL(url)}}})});
```
页面上会出现一个「导出GPX」的按钮，点击即可。

上面代码导出的 GPX 如果有坐标偏移（我导出的就有），可以用下面的代码导出坐标经过校正的数据。作者说会校正会损失精度并导致距离有偏差，我试了下，感觉还好。

```
$('<button type="submit" class="layui-btn layui-badge layui-bg-green" style="top:-5px;margin-left:10px" id="load_gpx"><i class="fas fa-save"></i> 导出GPX</button>').prependTo("#breadcrumb").bind("click",function(){$.ajax({url:"/Dc/Api",type:"get",dataType:"json",data:{_:"User/Record/get_record_info",record_id:RECORD_ID,coordinate_id:3,student_user_id:STUDENT_USER_ID,group_id:GROUP_ID},success:function(t){if(0===t.status){const e=t.data,n='<?xml version="1.0" encoding="UTF-8"?><gpx creator="Garmin Connect" version="1.1" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/11.xsd" xmlns:ns3="http://www.garmin.com/xmlschemas/TrackPointExtension/v1" xmlns="http://www.topografix.com/GPX/1/1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ns2="http://www.garmin.com/xmlschemas/GpxExtensions/v3"><metadata><link href="connect.garmin.com"><text>Garmin Connect</text></link><time></time></metadata><trk><name>下午跑步</name><type>running</type><trkseg></trkseg></trk></gpx>',a=(new DOMParser).parseFromString(n,"text/xml"),i=a.getElementsByTagName("trkseg")[0];a.getElementsByTagName("name")[0].textContent="导出的数据",a.getElementsByTagName("time")[0].textContent=new Date(1e3*e.swim_length_sum.start_time).toISOString(),e.trkpt.forEach(t=>{const e=a.createElement("trkpt");let n=CoordinateUtil.getWgs84xy(t.position_long,t.position_lat);e.setAttribute("lat",n.lat),e.setAttribute("lon",n.lng);const o=a.createElement("ele");o.textContent=t.altitude,e.appendChild(o);const r=a.createElement("time");r.textContent=new Date(1e3*t.timestamp).toISOString(),e.appendChild(r);const s=a.createElement("extensions"),l=a.createElement("ns3:TrackPointExtension"),c=a.createElement("ns3:hr");c.textContent=t.heart_rate,l.appendChild(c);const d=a.createElement("ns3:cad");d.textContent=t.cadence,l.appendChild(d),s.appendChild(l),e.appendChild(s),i.appendChild(e)});const o=(new XMLSerializer).serializeToString(a).replace(/xmlns=""/g,""),r=new Blob([o],{type:"application/gpx+xml"}),s=URL.createObjectURL(r),l=document.createElement("a");l.href=s,l.download="file.gpx",document.body.appendChild(l),l.click(),URL.revokeObjectURL(s)}}})});var CoordinateUtil={x_pi:52.35987755982988,pi:3.141592653589793,ee:.006693421622965943,a:6378245,bd09togcj02:function(t,e){var n=t-.0065,a=e-.006,i=Math.sqrt(n*n+a*a)-2e-5*Math.sin(a*CoordinateUtil.x_pi),o=Math.atan2(a,n)-3e-6*Math.cos(n*CoordinateUtil.x_pi);return{lng:i*Math.cos(o),lat:i*Math.sin(o)}},gcj02tobd09:function(t,e){var n=Math.sqrt(t*t+e*e)+2e-5*Math.sin(e*CoordinateUtil.x_pi),a=Math.atan2(e,t)+3e-6*Math.cos(t*CoordinateUtil.x_pi);return{lng:n*Math.cos(a)+.0065,lat:n*Math.sin(a)+.006}},gcj02towgs84:function(t,e){var n=CoordinateUtil.transformlat(t-105,e-35),a=CoordinateUtil.transformlng(t-105,e-35),i=e/180*CoordinateUtil.pi,o=Math.sin(i);o=1-CoordinateUtil.ee*o*o;var r=Math.sqrt(o);return n=180*n/(CoordinateUtil.a*(1-CoordinateUtil.ee)/(o*r)*CoordinateUtil.pi),{lng:2*t-(t+(a=180*a/(CoordinateUtil.a/r*Math.cos(i)*CoordinateUtil.pi))),lat:2*e-(e+n)}},transformlat:function(t,e){var n=2*t-100+3*e+.2*e*e+.1*t*e+.2*Math.sqrt(Math.abs(t));return n+=2*(20*Math.sin(6*t*CoordinateUtil.pi)+20*Math.sin(2*t*CoordinateUtil.pi))/3,n+=2*(20*Math.sin(e*CoordinateUtil.pi)+40*Math.sin(e/3*CoordinateUtil.pi))/3,n+=2*(160*Math.sin(e/12*CoordinateUtil.pi)+320*Math.sin(e*CoordinateUtil.pi/30))/3},transformlng:function(t,e){var n=300+t+2*e+.1*t*t+.1*t*e+.1*Math.sqrt(Math.abs(t));return n+=2*(20*Math.sin(6*t*CoordinateUtil.pi)+20*Math.sin(2*t*CoordinateUtil.pi))/3,n+=2*(20*Math.sin(t*CoordinateUtil.pi)+40*Math.sin(t/3*CoordinateUtil.pi))/3,n+=2*(150*Math.sin(t/12*CoordinateUtil.pi)+300*Math.sin(t/30*CoordinateUtil.pi))/3},getWgs84xy:function(t,e){var n=CoordinateUtil.bd09togcj02(t,e);return CoordinateUtil.gcj02towgs84(n.lng,n.lat)}};
```

有很多网站可以可视化 GPX 文件，比如 <https://gpx.studio/>, <https://www.gpxvisualizer.com/> 等，这些网站也有合并多个 GPX 文件等功能。
